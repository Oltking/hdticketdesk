generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String            @id @default(cuid())
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  email                   String            @unique
  password                String?           // Nullable for social-only accounts
  role                    UserRole          @default(BUYER)
  firstName               String?
  lastName                String?
  phone                   String?
  avatarUrl               String?           // Profile picture from social providers
  emailVerified           Boolean           @default(false)
  emailVerifiedAt         DateTime?
  verificationToken       String?
  verificationTokenExpiry DateTime?
  loginOtp                String?
  loginOtpExpiry          DateTime?
  passwordResetToken      String?
  passwordResetExp        DateTime?
  failedLoginAttempts     Int               @default(0)
  lockedUntil             DateTime?
  lastLoginAt             DateTime?
  lastLoginIp             String?
  // OAuth provider IDs
  googleId                String?           @unique
  organizerProfile        OrganizerProfile?
  payments                Payment[]
  refreshTokens           RefreshToken[]
  refunds                 Refund[]
  tickets                 Ticket[]

  @@index([email])
  @@index([googleId])
}

model OrganizerProfile {
  id                    String          @id @default(cuid())
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  title                 String
  description           String?
  logo                  String?
  website               String?
  bankName              String?
  bankCode              String?
  accountNumber         String?
  accountName           String?
  bankVerified          Boolean         @default(false)
  monnifyRecipientCode  String?         // Monnify beneficiary code for transfers
  pendingBalance        Decimal         @default(0) @db.Decimal(12, 2)
  availableBalance      Decimal         @default(0) @db.Decimal(12, 2)
  withdrawnBalance      Decimal         @default(0) @db.Decimal(12, 2)
  notificationsEnabled  Boolean         @default(true)
  userId                String          @unique
  events                Event[]
  ledgerEntries         LedgerEntry[]
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  withdrawals           Withdrawal[]
  virtualAccount        VirtualAccount?

  @@index([userId])
}

// Virtual account for each organizer (created when they publish their first event)
model VirtualAccount {
  id                  String           @id @default(cuid())
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  accountNumber       String           @unique
  accountName         String
  bankName            String
  bankCode            String
  accountReference    String           @unique  // Monnify reference for the VA
  monnifyContractCode String           // Monnify contract code
  isActive            Boolean          @default(true)
  organizerId         String           @unique
  organizer           OrganizerProfile @relation(fields: [organizerId], references: [id], onDelete: Cascade)

  @@index([accountNumber])
  @@index([accountReference])
}

model Event {
  id                 String             @id @default(cuid())
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  title              String
  slug               String             @unique
  description        String?
  status             EventStatus        @default(DRAFT)
  startDate          DateTime?          // Nullable for draft events, required for publishing
  endDate            DateTime?
  location           String?
  latitude           Float?
  longitude          Float?
  isLocationPublic   Boolean            @default(true)
  isOnline           Boolean            @default(false)
  onlineLink         String?
  coverImage         String?
  gallery            String[]           @default([])
  isFeatured         Boolean            @default(false)
  maxTicketsPerOrder Int                @default(10)
  passFeeTobuyer     Boolean            @default(false) // If true, 5% service fee is added to buyer's payment
  hideTicketSalesProgress Boolean        @default(false) // If true, hides ticket sales indicators (quantity left, % sold, progress bars) from public views
  organizerId        String
  organizer          OrganizerProfile   @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  agentAccessCodes   AgentAccessCode[]
  payments           Payment[]
  tickets            Ticket[]
  tiers              TicketTier[]

  @@index([slug])
  @@index([organizerId])
  @@index([status])
  @@index([startDate])
}

model TicketTier {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  name          String    @default("") // Can be empty for drafts, validated on publish
  description   String?
  price         Decimal   @default(0) @db.Decimal(12, 2)
  capacity      Int       @default(1)
  sold          Int       @default(0)
  refundEnabled Boolean   @default(false)
  sortOrder     Int       @default(0)
  saleEndDate   DateTime? // Date and time when ticket sales end for this tier
  eventId       String
  payments      Payment[]
  tickets       Ticket[]
  event         Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model Ticket {
  id             String       @id @default(cuid())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  ticketNumber   String       @unique
  qrCode         String
  qrCodeUrl      String?
  status         TicketStatus @default(ACTIVE)
  buyerEmail     String
  buyerFirstName String?
  buyerLastName  String?
  buyerPhone     String?
  checkedInAt    DateTime?
  checkedInBy    String?
  amountPaid     Decimal      @db.Decimal(12, 2)
  paymentRef     String?      // Monnify transaction reference
  eventId        String
  tierId         String
  buyerId        String?      // Nullable for guest checkouts
  paymentId      String?
  refund         Refund?
  buyer          User?        @relation(fields: [buyerId], references: [id])
  event          Event        @relation(fields: [eventId], references: [id])
  payment        Payment?     @relation(fields: [paymentId], references: [id])
  tier           TicketTier   @relation(fields: [tierId], references: [id])

  @@index([ticketNumber])
  @@index([eventId])
  @@index([buyerId])
  @@index([status])
  @@index([eventId, status])
  @@index([buyerEmail, eventId])
}

model Payment {
  id                    String        @id @default(cuid())
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  reference             String        @unique
  amount                Decimal       @db.Decimal(12, 2)
  status                PaymentStatus @default(PENDING)
  buyerEmail            String
  monnifyTransactionRef String?       // Monnify transaction reference
  monnifyPaymentRef     String?       // Monnify payment reference
  paidAt                DateTime?
  eventId               String
  tierId                String
  buyerId               String?
  organizerId           String?       // Reference to the organizer for reconciliation
  buyer                 User?         @relation(fields: [buyerId], references: [id])
  event                 Event         @relation(fields: [eventId], references: [id])
  tier                  TicketTier    @relation(fields: [tierId], references: [id])
  tickets               Ticket[]

  @@index([reference])
  @@index([eventId])
  @@index([buyerId])
  @@index([organizerId])
  @@index([monnifyTransactionRef])
  @@index([status, createdAt])
  @@index([buyerId, status])
}

model Refund {
  id                String       @id @default(cuid())
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  status            RefundStatus @default(PENDING)
  reason            String?
  refundAmount      Decimal      @db.Decimal(12, 2)
  processedAt       DateTime?
  processedBy       String?
  rejectionNote     String?
  monnifyRefundRef  String?      // Monnify refund reference
  ticketId          String       @unique
  requesterId       String
  requester         User         @relation(fields: [requesterId], references: [id])
  ticket            Ticket       @relation(fields: [ticketId], references: [id])

  @@index([ticketId])
  @@index([status])
}

model Withdrawal {
  id                    String           @id @default(cuid())
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  amount                Decimal          @db.Decimal(12, 2)
  status                WithdrawalStatus @default(PENDING)
  bankName              String
  bankCode              String
  accountNumber         String
  accountName           String
  otpCode               String?
  otpExpiresAt          DateTime?
  otpAttempts           Int              @default(0)
  monnifyTransferRef    String?          // Monnify transfer reference
  monnifyTransferCode   String?          // Monnify transfer code/batch ID
  monnifyTransferStatus String?          // Status from Monnify webhook
  processedAt           DateTime?
  failureReason         String?
  organizerId           String
  organizer             OrganizerProfile @relation(fields: [organizerId], references: [id], onDelete: Cascade)

  @@index([organizerId])
  @@index([status])
  @@index([monnifyTransferRef])
}

model LedgerEntry {
  id                    String           @id @default(cuid())
  
  // ============================================================================
  // PROFESSIONAL ACCOUNTING TIMESTAMPS
  // ============================================================================
  // entryDate: When this ledger entry was recorded in the system (audit trail)
  entryDate             DateTime         @default(now()) @map("createdAt")
  // valueDate: When the transaction actually occurred (e.g., payment timestamp from Monnify)
  valueDate             DateTime         @default(now())
  // settledDate: When the funds were actually settled/cleared (nullable until settled)
  settledDate           DateTime?
  
  // ============================================================================
  // TRANSACTION CLASSIFICATION
  // ============================================================================
  type                  LedgerType
  // Entry number for sequential tracking within organizer's ledger
  entryNumber           Int?             // Auto-generated sequential number per organizer
  
  // ============================================================================
  // DOUBLE-ENTRY ACCOUNTING: DEBIT & CREDIT
  // ============================================================================
  // In accounting: 
  //   - DEBIT increases assets/expenses, decreases liabilities/income
  //   - CREDIT increases liabilities/income, decreases assets/expenses
  // For organizer's perspective (their account is an asset to them):
  //   - TICKET_SALE: Credit (money coming IN)
  //   - WITHDRAWAL/REFUND/CHARGEBACK: Debit (money going OUT)
  debit                 Decimal          @default(0) @db.Decimal(12, 2)  // Money OUT (withdrawals, refunds, chargebacks)
  credit                Decimal          @default(0) @db.Decimal(12, 2) // Money IN (ticket sales)
  // Net amount for quick calculations (credit - debit), kept for backward compatibility
  amount                Decimal          @db.Decimal(12, 2)
  
  // ============================================================================
  // RUNNING BALANCES (snapshot after this transaction)
  // ============================================================================
  pendingBalanceAfter   Decimal          @db.Decimal(12, 2)
  availableBalanceAfter Decimal          @db.Decimal(12, 2)
  runningBalance        Decimal?         @db.Decimal(12, 2) // Total balance (pending + available) after this entry
  
  // ============================================================================
  // DESCRIPTION & NARRATION
  // ============================================================================
  description           String?          // Short description
  narration             String?          // Detailed narration for accounting purposes
  
  // ============================================================================
  // PAYMENT GATEWAY REFERENCES (for reconciliation & deduplication)
  // ============================================================================
  monnifyTransactionRef String?          // Unique Monnify transaction reference (MNFY_xxx)
  paymentReference      String?          // Our internal payment reference (HD-xxx)
  paymentId             String?          // Link to Payment record
  externalReference     String?          // Any other external reference (Paystack, bank, etc.)
  
  // ============================================================================
  // RELATED ENTITY IDs
  // ============================================================================
  ticketId              String?
  withdrawalId          String?
  refundId              String?
  organizerId           String
  organizer             OrganizerProfile @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  
  // ============================================================================
  // AUDIT & STATUS
  // ============================================================================
  status                LedgerStatus     @default(CONFIRMED)
  createdBy             String?          // User/system that created this entry
  notes                 String?          // Internal notes (admin use)

  @@unique([monnifyTransactionRef, type], name: "unique_monnify_ref_per_type")
  @@index([organizerId])
  @@index([type])
  @@index([entryDate])
  @@index([valueDate])
  @@index([settledDate])
  @@index([monnifyTransactionRef])
  @@index([paymentId])
  @@index([status])
  @@index([organizerId, entryDate])
  @@index([organizerId, valueDate])
}

model RefreshToken {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

enum UserRole {
  BUYER
  ORGANIZER
  ADMIN
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum TicketStatus {
  ACTIVE
  CHECKED_IN
  CANCELLED
  REFUNDED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSED
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum LedgerType {
  TICKET_SALE
  REFUND
  WITHDRAWAL
  CHARGEBACK
  ADJUSTMENT
}

enum LedgerStatus {
  PENDING     // Entry created but not yet confirmed (e.g., pending payment verification)
  CONFIRMED   // Entry confirmed and final
  REVERSED    // Entry has been reversed/cancelled
  DISPUTED    // Entry is under dispute
}

// Agent access codes for event check-in
// These are 9-character codes (mixed letters and numbers) that organizers generate
// for agents to use for scanning tickets at events without needing an account
model AgentAccessCode {
  id              String    @id @default(cuid())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  code            String    @unique  // 9-character secure code (e.g., "A3B7C9D2E")
  label           String?   // Optional label/name for the agent (e.g., "Gate 1", "John")
  isActive        Boolean   @default(true)
  activatedAt     DateTime? // When the code was first used
  lastUsedAt      DateTime? // Last time the code was used for check-in
  checkInCount    Int       @default(0) // Number of successful check-ins by this agent
  eventId         String
  event           Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([eventId])
  @@index([eventId, isActive])
}
